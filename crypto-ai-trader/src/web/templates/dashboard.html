<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SpringAI Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  <meta http-equiv="refresh" content="60">
</head>
<body class="dashboard-layout">
  <header class="dashboard-header">
    <div>
      <h1>SpringAI Dashboard</h1>
      <p style="color:#6b7280; margin:0;">Real-time positions & performance</p>
    </div>
    <div style="display: flex; align-items: center; gap: 16px;">
      <!-- Screening Results Link -->
      <a href="{{ url_for('screening_results_page') }}" style="padding: 8px 16px; background: #8b5cf6; color: white; border-radius: 6px; text-decoration: none; font-size: 0.9rem; font-weight: 600;">üìä Screening</a>
      
      <!-- 5. Toggle Button for Trading Mode -->
      <div style="display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 0.9rem; color: #6b7280;">Monitoring</span>
        <label class="toggle-switch">
          <input type="checkbox" id="tradingModeToggle" {% if not monitoring_mode %}checked{% endif %} onchange="toggleTradingMode(this.checked)">
          <span class="toggle-slider"></span>
        </label>
        <span style="font-size: 0.9rem; font-weight: 600; color: {% if monitoring_mode %}#6b7280{% else %}#10b981{% endif %};">LIVE</span>
      </div>
      <button onclick="location.href='{{ url_for('login') }}'">Logout</button>
    </div>
  </header>
  
  <!-- 2. Last Claude Response -->
  <section class="section-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
    <h2 style="color: white; border-bottom-color: rgba(255,255,255,0.2);">ü§ñ Last Claude AI Response</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 12px;">
      {% if last_claude_response.symbol %}
        <div><strong>Symbol:</strong> {{ last_claude_response.symbol }}</div>
        <div><strong>Signal:</strong> <span style="padding: 2px 8px; background: rgba(255,255,255,0.2); border-radius: 4px;">{{ last_claude_response.signal }}</span></div>
        {% if last_claude_response.edge %}
        <div><strong>Edge:</strong> <span style="padding: 2px 8px; background: {% if last_claude_response.edge == 'STRONG' %}rgba(16, 185, 129, 0.3){% elif last_claude_response.edge == 'MODERATE' %}rgba(245, 158, 11, 0.3){% else %}rgba(107, 114, 128, 0.3){% endif %}; border-radius: 4px; font-weight: 600;">{{ last_claude_response.edge }}</span></div>
        {% else %}
        <div><strong>Confidence:</strong> {{ last_claude_response.confidence }}%</div>
        {% endif %}
        <div><strong>Time:</strong> {{ last_claude_response.timestamp[:19] if last_claude_response.timestamp != 'N/A' else 'N/A' }}</div>
        <div><strong>Age:</strong> {{ last_claude_response.age or 'N/A' }}</div>
      {% else %}
        <div>{{ last_claude_response.message or last_claude_response.error or 'Waiting for first response...' }}</div>
      {% endif %}
    </div>
    {% if last_claude_response.rationale and last_claude_response.rationale != 'N/A' %}
    <div style="margin-top: 12px; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px;">
      <strong>Rationale:</strong> {{ last_claude_response.rationale }}
    </div>
    {% endif %}
  </section>
  
  <!-- 3. Scan Timing (Sydney Time) -->
  <section class="section-card" style="background: #f9fafb; margin-bottom: 20px;">
    <h2>‚è∞ Scan Schedule (Sydney Time)</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 12px;">
      <div style="padding: 16px; background: white; border-radius: 8px; border-left: 4px solid #10b981;">
        <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 4px;">LAST SCAN</div>
        <div style="font-size: 1.1rem; font-weight: 600; color: #111827;">{{ scan_info.last_scan }}</div>
      </div>
      <div style="padding: 16px; background: white; border-radius: 8px; border-left: 4px solid #3b82f6;">
        <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 4px;">NEXT SCAN</div>
        <div style="font-size: 1.1rem; font-weight: 600; color: #111827;">{{ scan_info.next_scan }}</div>
      </div>
      <div style="padding: 16px; background: white; border-radius: 8px; border-left: 4px solid #f59e0b;">
        <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 4px;">INTERVAL</div>
        <div style="font-size: 1.1rem; font-weight: 600; color: #111827;">Every {{ scan_info.interval_minutes }} minutes</div>
      </div>
    </div>
  </section>
  
  <section class="metrics-grid">
    {% for metric in metrics %}
    <article class="metric">
      <strong>{{ metric.label }}</strong>
      <div class="value">{{ metric.value }}</div>
      <div class="helper">{{ metric.helper }}</div>
    </article>
    {% endfor %}
  </section>
  <section class="section-card">
    <h2>Active Trades <span style="font-size: 0.85rem; color: #6b7280; font-weight: normal;">(Goldilock Strategy: DOGE/SHIB/SOL)</span></h2>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Quantity</th>
            <th>Entry</th>
            <th>Current</th>
            <th>High</th>
            <th>P&amp;L</th>
            <th>Stop Loss</th>
            <th>TP1 (+15%)</th>
            <th>Hold Days</th>
            <th>Strategy Status</th>
            <th>Last Update</th>
          </tr>
        </thead>
        <tbody>
          {% for trade in active_trades %}
          <tr>
            <td><strong>{{ trade.symbol }}</strong></td>
            <td>{{ "%.8g" % trade.quantity }}</td>
            <td>${{ "%.4f" % trade.entry }}</td>
            <td>${{ "%.4f" % trade.current }}</td>
            <td style="color: #8b5cf6; font-weight: 600;">${{ "%.4f" % trade.highest_price }}</td>
            <td style="color: {{ '#10b981' if trade.pnl >= 0 else '#ef4444' }}; font-weight: 600;">{{ '+' if trade.pnl >= 0 else '' }}${{ "%.2f" % trade.pnl }} ({{ "%+.1f" % trade.pnl_percent }}%)</td>
            <td>${{ "%.4f" % trade.stop_loss }} <br><span style="font-size: 0.75rem; color: #6b7280;">{{ '8%' if trade.hold_days < 7 else '3%' }}</span></td>
            <td>${{ "%.4f" % trade.take_profit }} <br>{% if trade.tp1_hit %}<span style="font-size: 0.75rem; color: #10b981; font-weight: 600;">‚úì HIT</span>{% else %}<span style="font-size: 0.75rem; color: #6b7280;">Pending</span>{% endif %}</td>
            <td style="text-align: center;">
              <strong>{{ trade.hold_days }}</strong><br>
              <span style="font-size: 0.75rem; color: {{ '#f59e0b' if trade.hold_days < 7 else '#10b981' if trade.hold_days < 90 else '#ef4444' }};">
                {{ 'Min hold' if trade.hold_days < 7 else 'Active' if trade.hold_days < 90 else 'MAX!' }}
              </span>
            </td>
            <td>
              <span style="padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 600; {% if trade.hold_days < 7 %}background: #fef3c7; color: #92400e{% elif trade.tp1_hit %}background: #d1fae5; color: #065f46{% elif trade.hold_days >= 90 %}background: #fee2e2; color: #991b1b{% else %}background: #e0e7ff; color: #3730a3{% endif %}">
                {{ trade.strategy_status }}
              </span>
            </td>
            <td style="font-size: 0.85rem; color: #6b7280;">{{ trade.last_update }}</td>
          </tr>
          {% else %}
          <tr><td colspan="11" style="text-align: center; padding: 24px; color: #6b7280;">No open trades - Waiting for next signal (DOGE/SHIB/SOL only)</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <!-- Goldilock Strategy Legend -->
    <div style="margin-top: 16px; padding: 12px; background: #f9fafb; border-radius: 8px; font-size: 0.85rem;">
      <strong style="color: #111827;">Strategy Info:</strong>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 8px;">
        <div><span style="color: #f59e0b;">‚óè</span> <strong>Days 0-6:</strong> 8% SL (min hold, only SL exits)</div>
        <div><span style="color: #10b981;">‚óè</span> <strong>Day 7+:</strong> 3% SL, TP1/TP2 enabled</div>
        <div><span style="color: #8b5cf6;">‚óè</span> <strong>TP1 (+15%):</strong> Close 50%, activate trailing</div>
        <div><span style="color: #3b82f6;">‚óè</span> <strong>TP2 (+30%):</strong> Close remaining 50%</div>
        <div><span style="color: #ec4899;">‚óè</span> <strong>Trailing:</strong> 5% from highest (after TP1)</div>
        <div><span style="color: #ef4444;">‚óè</span> <strong>Day 90:</strong> Max hold - force exit</div>
      </div>
    </div>
  </section>
  <section class="section-card">
    <h2>ü§ñ AI Signals - Potential Coins (Last 24h)</h2>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Signal</th>
            <th>Edge/Conf</th>
            <th>Price</th>
            <th>Stop Loss</th>
            <th>Take Profit</th>
            <th>Rationale</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody>
          {% for signal in recent_signals %}
          <tr>
            <td><strong>{{ signal.symbol }}</strong></td>
            <td>
              <span class="badge" style="background: {% if signal.signal_type == 'BUY' %}#dcfce7; color: #166534{% elif signal.signal_type == 'SELL' %}#fee2e2; color: #991b1b{% else %}#f3f4f6; color: #374151{% endif %}">
                {{ signal.signal_type }}
              </span>
            </td>
            <td>
              {% if signal.edge %}
                <span style="padding: 3px 8px; border-radius: 4px; font-weight: 600; font-size: 0.85rem; {% if signal.edge == 'STRONG' %}background: #d1fae5; color: #065f46{% elif signal.edge == 'MODERATE' %}background: #fed7aa; color: #92400e{% else %}background: #f3f4f6; color: #6b7280{% endif %}">
                  {{ signal.edge }}
                </span>
              {% else %}
                <span style="font-weight: 600; color: {% if signal.confidence >= 70 %}#10b981{% elif signal.confidence >= 50 %}#f59e0b{% else %}#6b7280{% endif %}">
                  {{ signal.confidence }}%
                </span>
              {% endif %}
            </td>
            <td>${{ "%.2f"|format(signal.current_price) if signal.current_price >= 1 else "%.4f"|format(signal.current_price) }}</td>
            <td>
              {% if signal.stop_loss %}
                ${{ "%.2f"|format(signal.stop_loss) if signal.stop_loss >= 1 else "%.4f"|format(signal.stop_loss) }}
              {% else %}
                N/A
              {% endif %}
            </td>
            <td>
              {% if signal.take_profit %}
                {% if signal.take_profit is iterable and signal.take_profit is not string %}
                  ${{ "%.2f"|format(signal.take_profit[0]) if signal.take_profit[0] >= 1 else "%.4f"|format(signal.take_profit[0]) }}
                  {% if signal.take_profit|length > 1 %}
                    <small style="color:#6b7280">(+{{ signal.take_profit|length - 1 }} more)</small>
                  {% endif %}
                {% else %}
                  ${{ "%.2f"|format(signal.take_profit) if signal.take_profit >= 1 else "%.4f"|format(signal.take_profit) }}
                {% endif %}
              {% else %}
                N/A
              {% endif %}
            </td>
            <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ signal.rationale }}">
              {{ signal.rationale|truncate(60) }}
            </td>
            <td style="font-size: 0.85rem; color: #6b7280;">
              {{ signal.timestamp|default('N/A') }}
            </td>
          </tr>
          {% else %}
          <tr><td colspan="8" style="text-align: center; padding: 40px;">
            <div style="font-size: 3rem; margin-bottom: 10px;">ü§ñ</div>
            <strong>No AI signals yet</strong><br>
            <span style="color: #6b7280; font-size: 0.9rem;">Run the signal generator to analyze potential trading opportunities</span><br>
            <code style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px; margin-top: 10px; display: inline-block; font-size: 0.85rem;">
              python3 -m src.ai.signal_generator
            </code>
          </td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% if signal_stats.total > 0 %}
    <div style="margin-top: 16px; padding: 12px; background: #f9fafb; border-radius: 8px; display: flex; gap: 24px; flex-wrap: wrap;">
      <div><strong>Total Signals:</strong> {{ signal_stats.total }}</div>
      <div><strong>BUY:</strong> <span style="color: #10b981;">{{ signal_stats.buy }}</span></div>
      <div><strong>SELL:</strong> <span style="color: #ef4444;">{{ signal_stats.sell }}</span></div>
      <div><strong>HOLD:</strong> <span style="color: #6b7280;">{{ signal_stats.hold }}</span></div>
      {% if signal_stats.strong_edge is defined %}
      <div><strong>STRONG Edge:</strong> <span style="color: #10b981; font-weight: 600;">{{ signal_stats.strong_edge }}</span></div>
      <div><strong>MODERATE Edge:</strong> <span style="color: #f59e0b; font-weight: 600;">{{ signal_stats.moderate_edge }}</span></div>
      {% else %}
      <div><strong>High Confidence (‚â•70%):</strong> <span style="color: #10b981; font-weight: 600;">{{ signal_stats.high_confidence }}</span></div>
      {% endif %}
    </div>
    {% endif %}
  </section>
  <section class="section-card">
    <h2>Recent Closed Trades</h2>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Entry</th>
            <th>Exit</th>
            <th>P&amp;L</th>
            <th>Duration</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for trade in closed_trades %}
          <tr>
            <td>{{ trade.symbol }}</td>
            <td>${{ "%.4f" % trade.entry if trade.entry < 1 else "%.2f" % trade.entry }}</td>
            <td>${{ "%.4f" % trade.exit if trade.exit < 1 else "%.2f" % trade.exit }}</td>
            <td style="color: {{ '#10b981' if trade.pnl >= 0 else '#ef4444' }};">{{ '+' if trade.pnl >=0 else '' }}${{ "%.2f" % trade.pnl }}</td>
            <td>{{ trade.duration }}</td>
            <td><span class="badge{% if trade.pnl < 0 %} negative{% endif %}">{{ trade.status }}</span></td>
          </tr>
          {% else %}
          <tr><td colspan="6">No closed trades yet</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
  <div class="stats-grid">
    <div class="stats-card">
      <h3>Top Performers (30d)</h3>
      {% for trade in top_performers %}
      <div class="value">{{ trade.symbol }} ({{ '{:+.2f}' | format(trade.pnl_percent) }}%)</div>
      {% else %}
      <div class="value">No data</div>
      {% endfor %}
    </div>
    <div class="stats-card">
      <h3>Strategy Stats</h3>
      <div class="value">Total Trades: {{ strategy_stats.total_trades }}</div>
      <div class="value">Avg Win: ${{ "%.2f"|format(strategy_stats.avg_win if strategy_stats.avg_win else 0) }}</div>
      <div class="value">Avg Loss: ${{ "%.2f"|format(strategy_stats.avg_loss if strategy_stats.avg_loss else 0) }}</div>
      <div class="value">Profit Factor: {{ "%.2f"|format(strategy_stats.profit_factor if strategy_stats.profit_factor else 0) }}</div>
    </div>
    <div class="stats-card">
      <h3>Risk Metrics</h3>
      <div class="value" style="color:#ef4444;">Max Drawdown: {{ risk_metrics.max_drawdown }}</div>
      <div class="value">Sharpe Ratio: {{ risk_metrics.sharpe_ratio }}</div>
      <div class="value">Risk/Reward: {{ risk_metrics.risk_reward }}</div>
    </div>
  </div>
  
  <script>
    // Toggle Trading Mode
    function toggleTradingMode(enableLive) {
      const toggle = document.getElementById('tradingModeToggle');
      const label = toggle.nextElementSibling.nextElementSibling;
      
      fetch('{{ url_for("toggle_trading_mode") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ enable_live: enableLive })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          label.textContent = enableLive ? 'LIVE' : 'MONITORING';
          label.style.color = enableLive ? '#10b981' : '#6b7280';
          
          // Show notification
          showNotification(data.message, 'success');
          
          // Optionally reload after 1 second
          setTimeout(() => location.reload(), 1000);
        } else {
          showNotification('Failed to toggle mode: ' + data.error, 'error');
          toggle.checked = !enableLive; // Revert toggle
        }
      })
      .catch(error => {
        showNotification('Error: ' + error, 'error');
        toggle.checked = !enableLive; // Revert toggle
      });
    }
    
    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        background: ${type === 'success' ? '#10b981' : '#ef4444'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
      `;
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
    
    // Auto-refresh every 30 seconds to update USDT balance and Claude response
    setInterval(() => {
      location.reload();
    }, 30000);
  </script>
  
  <style>
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
  </style>
</body>
</html>
